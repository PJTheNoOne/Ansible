---
# Not needed
# - name: Create AppImage install directory
#   file:
#     path: "{{ appimage_install_dir }}"
#     state: directory
#   become: true

- name: Download and install AppImages
  uri:
    url: "{{ item.url }}"
    dest: "{{ appimage_install_dir }}/{{ item.name }}.AppImage"
    headers:
      User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/117.0
    method: GET
    owner: pj
    group: pj
    force: true
    status_code: [304]
  loop: "{{ appimages }}"
  register: downloaded_appimages
  become: true

- name: Download Appimages pngs
  get_url:
    url: "{{ item.image_url }}"
    dest: "{{ appimage_install_dir }}/{{ item.name }}.{{ item.image_format }}"
    headers:
      User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/117.0
    owner: pj
    group: pj    
    force: true
  loop: "{{ appimages }}"
  become: true

- name: Set execute permissions for AppImages
  file:
    path: "{{ appimage_install_dir }}/{{ item.item.name }}.AppImage"
    mode: 'u+x'
  loop: "{{ downloaded_appimages.results }}"
  become: true

- name: Template Desktop Files
  template:
    src: app_template.desktop.j2
    dest: "{{ appimage_install_dir }}/{{ item.item.name }}.desktop"
    owner: pj
    group: pj
    mode: u=rw,g=r,o=r
  loop: "{{ downloaded_appimages.results }}"